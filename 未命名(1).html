<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工行十五运徽章抽奖</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#FF7D00',
            success: '#00B42A',
            danger: '#F53F3F',
            neutral: '#86909C',
            light: '#F2F3F5',
            dark: '#1D2129'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      .prize-card {
        @apply bg-white rounded-xl shadow-lg p-5 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 cursor-pointer;
      }
      .btn-primary {
        @apply bg-primary text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 hover:bg-primary/90 focus:ring-4 focus:ring-primary/30 active:scale-95;
      }
      .btn-secondary {
        @apply bg-secondary text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 hover:bg-secondary/90 focus:ring-4 focus:ring-secondary/30 active:scale-95;
      }
      .form-input {
        @apply w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all outline-none;
      }
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen">
  <!-- 主容器 -->
  <div id="app" class="max-w-6xl mx-auto px-4 py-8">
    <!-- 登录页面 -->
    <div id="login-page" class="min-h-[80vh] flex flex-col items-center justify-center">
      <div class="w-full max-w-md">
        <div class="text-center mb-10">
          <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-trophy text-4xl text-primary"></i>
          </div>
          <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-dark mb-2">工行徽章抽奖系统</h1>
          <p class="text-neutral">请登录管理员账号</p>
        </div>
        
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <form id="login-form" class="space-y-5">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="username">用户名</label>
              <input type="text" id="username" class="form-input" placeholder="请输入用户名">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="password">密码</label>
              <input type="password" id="password" class="form-input" placeholder="请输入密码">
            </div>
            <button type="submit" class="btn-primary w-full flex items-center justify-center gap-2">
              <span>登录</span>
              <i class="fa fa-sign-in"></i>
            </button>
          </form>
          <div class="mt-6 text-center">
            <a href="#" id="user-enter" class="text-primary hover:underline text-sm">普通用户进入抽奖</a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 微信扫码页面 -->
    <div id="wechat-scan-page" class="hidden min-h-[80vh] flex flex-col items-center justify-center py-10">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold mb-3">请使用微信扫码</h2>
        <p class="text-neutral">扫描下方二维码，进入抽奖活动</p>
      </div>
      
      <div class="bg-white p-4 rounded-xl shadow-lg mb-8">
        <div class="w-64 h-64 mx-auto bg-gray-100 flex items-center justify-center">
          <!-- 这里是微信二维码占位区域 -->
          <img src="https://picsum.photos/256/256" alt="微信抽奖二维码" class="w-full h-full object-cover">
        </div>
      </div>
      
      <div class="text-center">
        <p class="text-neutral text-sm mb-4">扫码后请在微信中打开</p>
        <button id="scan-complete-btn" class="btn-primary">
          已扫码，进入抽奖
        </button>
      </div>
    </div>
    
    <!-- 用户抽奖页面 -->
    <div id="user-page" class="hidden">
      <!-- 头部 -->
      <header class="text-center mb-10">
        <div class="inline-block bg-primary/10 rounded-full px-6 py-2 mb-4">
          <span class="text-primary font-medium">工行十五运徽章抽奖</span>
        </div>
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-3">百九华诞限定好礼</h1>
        <p class="text-neutral max-w-2xl mx-auto">活动限定1000人参与，多重精美徽章等您抽取，中奖率超高！</p>
        <div class="mt-5 text-sm text-neutral">
          <span>已参与: <span id="participant-count">0</span>/1000</span>
        </div>
      </header>
      
      <!-- 抽奖区域 -->
      <div class="max-w-2xl mx-auto mb-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 relative overflow-hidden">
          <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-bl-full"></div>
          
          <div id="draw-ready" class="text-center">
            <div class="w-32 h-32 mx-auto mb-6 bg-primary/10 rounded-full flex items-center justify-center animate-float">
              <i class="fa fa-gift text-5xl text-primary"></i>
            </div>
            <h2 class="text-xl font-bold mb-3">准备好了吗？</h2>
            <p class="text-neutral mb-6">点击下方按钮，抽取您的专属徽章</p>
            <button id="draw-btn" class="btn-secondary text-lg px-8 py-4">
              立即抽奖
            </button>
          </div>
          
          <div id="drawing" class="text-center hidden">
            <div class="w-40 h-40 mx-auto mb-6 relative">
              <div class="absolute inset-0 border-4 border-primary/20 rounded-full animate-spin"></div>
              <div class="absolute inset-2 border-4 border-primary/40 rounded-full animate-spin" style="animation-duration: 1.5s;"></div>
              <div class="absolute inset-4 border-4 border-primary/60 rounded-full animate-spin" style="animation-duration: 2s;"></div>
              <div class="absolute inset-0 flex items-center justify-center">
                <i class="fa fa-refresh text-4xl text-primary animate-spin"></i>
              </div>
            </div>
            <h2 class="text-xl font-bold mb-3">正在抽奖中...</h2>
            <p class="text-neutral">幸运徽章即将揭晓</p>
          </div>
          
          <div id="draw-success" class="text-center hidden">
            <div class="w-32 h-32 mx-auto mb-6 bg-success/10 rounded-full flex items-center justify-center">
              <i class="fa fa-check text-5xl text-success"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">恭喜您中奖了！</h2>
            <p id="prize-name" class="text-lg font-medium text-primary mb-6">百九华诞工行十五运徽章"活力乒乓"</p>
            <p class="text-neutral mb-6">请填写以下信息，以便领取奖品</p>
            
            <form id="info-form" class="space-y-4 text-left">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="name">姓名</label>
                <input type="text" id="name" class="form-input" placeholder="请输入您的姓名" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="department">所在科室</label>
                <input type="text" id="department" class="form-input" placeholder="请输入所在科室" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="phone">手机号码</label>
                <input type="tel" id="phone" class="form-input" placeholder="请输入手机号码" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="id-card">身份证号</label>
                <input type="text" id="id-card" class="form-input" placeholder="请输入身份证号" required>
              </div>
              <button type="submit" class="btn-primary w-full mt-2">提交信息</button>
            </form>
          </div>
          
          <div id="draw-fail" class="text-center hidden">
            <div class="w-32 h-32 mx-auto mb-6 bg-neutral/10 rounded-full flex items-center justify-center">
              <i class="fa fa-meh-o text-5xl text-neutral"></i>
            </div>
            <h2 class="text-xl font-bold mb-3">很遗憾，未中奖</h2>
            <p class="text-neutral mb-6">感谢您的参与，祝您下次好运</p>
            <button id="retry-btn" class="btn-primary">
              再试一次
            </button>
          </div>
          
          <div id="draw-complete" class="text-center hidden">
            <div class="w-32 h-32 mx-auto mb-6 bg-primary/10 rounded-full flex items-center justify-center">
              <i class="fa fa-check-circle text-5xl text-primary"></i>
            </div>
            <h2 class="text-xl font-bold mb-3">信息提交成功</h2>
            <p class="text-neutral mb-6">请留意奖品发放通知，感谢您的参与</p>
            <button id="back-btn" class="btn-primary">
              返回首页
            </button>
          </div>
          
          <div id="draw-limit" class="text-center hidden">
            <div class="w-32 h-32 mx-auto mb-6 bg-danger/10 rounded-full flex items-center justify-center">
              <i class="fa fa-exclamation-triangle text-5xl text-danger"></i>
            </div>
            <h2 class="text-xl font-bold mb-3">参与人数已达上限</h2>
            <p class="text-neutral mb-6">本次活动限定1000人参与，感谢您的关注</p>
          </div>
        </div>
      </div>
      
      <!-- 奖品展示 -->
      <div class="mb-16">
        <h2 class="text-2xl font-bold text-center mb-8">精美奖品展示</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="prize-card">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-table-tennis text-2xl text-primary"></i>
            </div>
            <h3 class="font-bold mb-2">活力乒乓</h3>
            <p class="text-sm text-neutral">百九华诞工行十五运徽章</p>
          </div>
          
          <div class="prize-card">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-basketball-ball text-2xl text-primary"></i>
            </div>
            <h3 class="font-bold mb-2">激情篮球</h3>
            <p class="text-sm text-neutral">百九华诞工行十五运徽章</p>
          </div>
          
          <div class="prize-card">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-fist-raised text-2xl text-primary"></i>
            </div>
            <h3 class="font-bold mb-2">力量拳击</h3>
            <p class="text-sm text-neutral">百九华诞工行十五运徽章</p>
          </div>
          
          <div class="prize-card">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
              <i class="fa fa-table-tennis text-2xl text-primary"></i>
            </div>
            <h3 class="font-bold mb-2">飞扬羽毛球</h3>
            <p class="text-sm text-neutral">百九华诞工行十五运徽章</p>
          </div>
        </div>
      </div>
      
      <!-- 底部 -->
      <footer class="text-center text-neutral text-sm py-6 border-t">
        <p>活动最终解释权归主办方所有</p>
      </footer>
    </div>
    
    <!-- 管理员页面 -->
    <div id="admin-page" class="hidden">
      <!-- 顶部导航 -->
      <nav class="flex justify-between items-center mb-8 pb-4 border-b">
        <div class="flex items-center gap-2">
          <i class="fa fa-trophy text-primary text-xl"></i>
          <h1 class="text-xl font-bold">工行徽章抽奖管理系统</h1>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-sm text-neutral">管理员: admin</span>
          <button id="logout-btn" class="text-neutral hover:text-danger transition-colors">
            <i class="fa fa-sign-out mr-1"></i>退出
          </button>
        </div>
      </nav>
      
      <!-- 数据概览 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-neutral text-sm mb-1">总参与人数</p>
              <h3 class="text-3xl font-bold" id="total-participants">0</h3>
            </div>
            <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
              <i class="fa fa-users text-primary"></i>
            </div>
          </div>
          <div class="mt-4 text-xs text-success">
            <i class="fa fa-arrow-up mr-1"></i>占总名额 <span id="participant-percentage">0</span>%
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-neutral text-sm mb-1">中奖人数</p>
              <h3 class="text-3xl font-bold" id="total-winners">0</h3>
            </div>
            <div class="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center">
              <i class="fa fa-gift text-success"></i>
            </div>
          </div>
          <div class="mt-4 text-xs text-neutral">
            中奖率 <span id="win-rate">0</span>%
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-neutral text-sm mb-1">剩余奖品</p>
              <h3 class="text-3xl font-bold" id="remaining-prizes">188</h3>
            </div>
            <div class="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center">
              <i class="fa fa-box text-secondary"></i>
            </div>
          </div>
          <div class="mt-4 text-xs text-neutral">
            总奖品数 188 个
          </div>
        </div>
      </div>
      
      <!-- 图表区域 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold mb-4">奖品分布</h3>
          <div class="h-64">
            <canvas id="prize-chart"></canvas>
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold mb-4">参与趋势</h3>
          <div class="h-64">
            <canvas id="trend-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- 数据表格 -->
      <div class="bg-white rounded-xl shadow overflow-hidden mb-8">
        <div class="p-6 border-b flex justify-between items-center">
          <h3 class="font-bold">中奖用户信息</h3>
          <button id="export-btn" class="btn-primary text-sm px-4 py-2">
            <i class="fa fa-download mr-1"></i>导出数据
          </button>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-light">
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">姓名</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">科室</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">手机号码</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">身份证号</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">奖品</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">时间</th>
              </tr>
            </thead>
            <tbody id="winner-table-body" class="divide-y">
              <!-- 表格内容将通过JS动态生成 -->
              <tr>
                <td colspan="7" class="px-6 py-12 text-center text-neutral">暂无数据</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="p-4 border-t flex justify-between items-center text-sm text-neutral">
          <div>显示 0 条，共 0 条</div>
          <div class="flex gap-2">
            <button class="px-3 py-1 rounded border disabled:opacity-50" disabled>上一页</button>
            <button class="px-3 py-1 rounded border disabled:opacity-50" disabled>下一页</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 通知提示 -->
  <div id="toast" class="fixed top-4 right-4 bg-dark text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center gap-2 z-50">
    <i class="fa fa-info-circle"></i>
    <span id="toast-message">通知消息</span>
  </div>

  <script>
    // 全局数据存储
    const appData = {
      // 奖品数据
      prizes: [
        { id: 1, name: '百九华诞工行十五运徽章"活力乒乓"' },
        { id: 2, name: '百九华诞工行十五运徽章"激情篮球"' },
        { id: 3, name: '百九华诞工行十五运徽章"力量拳击"' },
        { id: 4, name: '百九华诞工行十五运徽章"飞扬羽毛球"' }
      ],
      prizeCounts: [47, 47, 47, 47], // 各奖品剩余数量（仅管理员可见）
      totalParticipants: 0, // 总参与人数
      maxParticipants: 1000, // 最大参与人数
      winners: [], // 中奖者列表
      currentUser: {
        hasParticipated: false,
        isWinner: false,
        prizeId: null,
        wechatScanned: false // 记录用户是否已扫码
      },
      // 模拟参与数据（用于图表展示）
      participationData: Array(7).fill(0)
    };

    // DOM元素
    const elements = {
      // 页面容器
      loginPage: document.getElementById('login-page'),
      wechatScanPage: document.getElementById('wechat-scan-page'),
      userPage: document.getElementById('user-page'),
      adminPage: document.getElementById('admin-page'),
      
      // 登录表单
      loginForm: document.getElementById('login-form'),
      usernameInput: document.getElementById('username'),
      passwordInput: document.getElementById('password'),
      userEnterLink: document.getElementById('user-enter'),
      
      // 扫码页面元素
      scanCompleteBtn: document.getElementById('scan-complete-btn'),
      
      // 用户抽奖页面
      drawBtn: document.getElementById('draw-btn'),
      retryBtn: document.getElementById('retry-btn'),
      backBtn: document.getElementById('back-btn'),
      infoForm: document.getElementById('info-form'),
      participantCount: document.getElementById('participant-count'),
      prizeName: document.getElementById('prize-name'),
      
      // 抽奖状态容器
      drawReady: document.getElementById('draw-ready'),
      drawing: document.getElementById('drawing'),
      drawSuccess: document.getElementById('draw-success'),
      drawFail: document.getElementById('draw-fail'),
      drawComplete: document.getElementById('draw-complete'),
      drawLimit: document.getElementById('draw-limit'),
      
      // 管理员页面
      logoutBtn: document.getElementById('logout-btn'),
      exportBtn: document.getElementById('export-btn'),
      totalParticipantsEl: document.getElementById('total-participants'),
      totalWinnersEl: document.getElementById('total-winners'),
      remainingPrizesEl: document.getElementById('remaining-prizes'),
      participantPercentageEl: document.getElementById('participant-percentage'),
      winRateEl: document.getElementById('win-rate'),
      winnerTableBody: document.getElementById('winner-table-body'),
      
      // 图表
      prizeChart: null,
      trendChart: null,
      
      // 通知提示
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toast-message')
    };

    // 工具函数
    const utils = {
      // 显示通知
      showToast(message) {
        elements.toastMessage.textContent = message;
        elements.toast.classList.remove('translate-x-full');
        
        setTimeout(() => {
          elements.toast.classList.add('translate-x-full');
        }, 3000);
      },
      
      // 切换页面
      showPage(pageId) {
        elements.loginPage.classList.add('hidden');
        elements.wechatScanPage.classList.add('hidden');
        elements.userPage.classList.add('hidden');
        elements.adminPage.classList.add('hidden');
        
        if (pageId === 'login') elements.loginPage.classList.remove('hidden');
        else if (pageId === 'wechat-scan') elements.wechatScanPage.classList.remove('hidden');
        else if (pageId === 'user') elements.userPage.classList.remove('hidden');
        else if (pageId === 'admin') {
          elements.adminPage.classList.remove('hidden');
          this.updateAdminDashboard();
        }
      },
      
      // 切换抽奖状态
      showDrawState(state) {
        elements.drawReady.classList.add('hidden');
        elements.drawing.classList.add('hidden');
        elements.drawSuccess.classList.add('hidden');
        elements.drawFail.classList.add('hidden');
        elements.drawComplete.classList.add('hidden');
        elements.drawLimit.classList.add('hidden');
        
        if (state === 'ready') elements.drawReady.classList.remove('hidden');
        else if (state === 'drawing') elements.drawing.classList.remove('hidden');
        else if (state === 'success') elements.drawSuccess.classList.remove('hidden');
        else if (state === 'fail') elements.drawFail.classList.remove('hidden');
        else if (state === 'complete') elements.drawComplete.classList.remove('hidden');
        else if (state === 'limit') elements.drawLimit.classList.remove('hidden');
      },
      
      // 生成随机ID
      generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      },
      
      // 格式化日期
      formatDate(date) {
        const d = new Date(date);
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
      }
    };

    // 抽奖逻辑
    const drawLogic = {
      // 开始抽奖
      startDraw() {
        // 检查是否已达参与上限
        if (appData.totalParticipants >= appData.maxParticipants) {
          utils.showDrawState('limit');
          return;
        }
        
        // 检查用户是否已参与
        if (appData.currentUser.hasParticipated) {
          utils.showToast('您已参与过抽奖');
          return;
        }
        
        // 显示抽奖中状态
        utils.showDrawState('drawing');
        
        // 增加参与人数
        appData.totalParticipants++;
        elements.participantCount.textContent = appData.totalParticipants;
        
        // 更新参与趋势数据（取最后7天）
        appData.participationData.push(1);
        appData.participationData.shift();
        
        // 模拟抽奖过程
        setTimeout(() => {
          this.processDrawResult();
        }, 2000);
      },
      
      // 处理抽奖结果
      processDrawResult() {
        // 标记用户已参与
        appData.currentUser.hasParticipated = true;
        
        // 计算中奖概率（约38%中奖率，因为188个奖品/500参与者）
        const winProbability = 0.38;
        const isWinner = Math.random() < winProbability;
        
        if (isWinner) {
          // 随机选择一个还有剩余的奖品
          const availablePrizes = appData.prizeCounts
            .map((count, index) => ({ index, count }))
            .filter(item => item.count > 0);
          
          if (availablePrizes.length === 0) {
            // 没有奖品了，视为未中奖
            utils.showDrawState('fail');
            return;
          }
          
          // 随机选择一个可用奖品
          const randomIndex = Math.floor(Math.random() * availablePrizes.length);
          const selectedPrize = availablePrizes[randomIndex];
          
          // 更新奖品数量（仅在后台记录，不在用户端显示）
          appData.prizeCounts[selectedPrize.index]--;
          
          // 记录中奖信息
          appData.currentUser.isWinner = true;
          appData.currentUser.prizeId = selectedPrize.index;
          
          // 显示中奖结果
          elements.prizeName.textContent = appData.prizes[selectedPrize.index].name;
          utils.showDrawState('success');
        } else {
          // 未中奖
          appData.currentUser.isWinner = false;
          appData.currentUser.prizeId = null;
          utils.showDrawState('fail');
        }
      },
      
      // 提交中奖信息
      submitWinnerInfo(formData) {
        // 创建中奖记录
        const winner = {
          id: utils.generateId(),
          name: formData.name,
          department: formData.department,
          phone: formData.phone,
          idCard: formData.idCard,
          prizeId: appData.currentUser.prizeId,
          prizeName: appData.prizes[appData.currentUser.prizeId].name,
          time: new Date().toISOString()
        };
        
        // 添加到中奖列表
        appData.winners.push(winner);
        
        // 显示提交成功状态
        utils.showDrawState('complete');
        utils.showToast('信息提交成功，感谢参与！');
      }
    };

    // 管理员功能
    const adminFunctions = {
      // 更新管理员仪表盘数据
      updateDashboard() {
        // 更新统计数据
        elements.totalParticipantsEl.textContent = appData.totalParticipants;
        elements.totalWinnersEl.textContent = appData.winners.length;
        
        const remainingPrizes = appData.prizeCounts.reduce((sum, count) => sum + count, 0);
        elements.remainingPrizesEl.textContent = remainingPrizes;
        
        const participantPercentage = Math.round((appData.totalParticipants / appData.maxParticipants) * 100);
        elements.participantPercentageEl.textContent = participantPercentage;
        
        const winRate = appData.totalParticipants > 0 
          ? Math.round((appData.winners.length / appData.totalParticipants) * 100) 
          : 0;
        elements.winRateEl.textContent = winRate;
        
        // 更新表格数据
        this.updateWinnerTable();
        
        // 更新图表
        this.updateCharts();
      },
      
      // 更新中奖者表格
      updateWinnerTable() {
        if (appData.winners.length === 0) {
          elements.winnerTableBody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-12 text-center text-neutral">暂无数据</td>
            </tr>
          `;
          return;
        }
        
        // 按时间倒序排列
        const sortedWinners = [...appData.winners].sort((a, b) => 
          new Date(b.time) - new Date(a.time)
        );
        
        elements.winnerTableBody.innerHTML = sortedWinners.map((winner, index) => `
          <tr class="hover:bg-light/50 transition-colors">
            <td class="px-6 py-4">${index + 1}</td>
            <td class="px-6 py-4">${winner.name}</td>
            <td class="px-6 py-4">${winner.department}</td>
            <td class="px-6 py-4">${winner.phone}</td>
            <td class="px-6 py-4">${this.maskIdCard(winner.idCard)}</td>
            <td class="px-6 py-4">${winner.prizeName}</td>
            <td class="px-6 py-4 text-sm text-neutral">${utils.formatDate(winner.time)}</td>
          </tr>
        `).join('');
      },
      
      // 身份证号脱敏
      maskIdCard(idCard) {
        if (!idCard) return '';
        return idCard.substr(0, 6) + '********' + idCard.substr(-4);
      },
      
      // 更新图表
      updateCharts() {
        // 奖品分布图表
        if (!elements.prizeChart) {
          elements.prizeChart = new Chart(
            document.getElementById('prize-chart'),
            {
              type: 'doughnut',
              data: {
                labels: appData.prizes.map(prize => prize.name.split('"')[1]),
                datasets: [{
                  data: appData.prizeCounts,
                  backgroundColor: [
                    '#165DFF',
                    '#36CFC9',
                    '#FF7D00',
                    '#F53F3F'
                  ],
                  borderWidth: 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'right'
                  }
                }
              }
            }
          );
        } else {
          elements.prizeChart.data.datasets[0].data = appData.prizeCounts;
          elements.prizeChart.update();
        }
        
        // 参与趋势图表
        if (!elements.trendChart) {
          elements.trendChart = new Chart(
            document.getElementById('trend-chart'),
            {
              type: 'line',
              data: {
                labels: ['7天前', '6天前', '5天前', '4天前', '3天前', '2天前', '昨天'],
                datasets: [{
                  label: '参与人数',
                  data: appData.participationData,
                  borderColor: '#165DFF',
                  backgroundColor: 'rgba(22, 93, 255, 0.1)',
                  tension: 0.4,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      precision: 0
                    }
                  }
                }
              }
            }
          );
        } else {
          elements.trendChart.data.datasets[0].data = appData.participationData;
          elements.trendChart.update();
        }
      },
      
      // 导出数据为CSV
      exportData() {
        if (appData.winners.length === 0) {
          utils.showToast('暂无数据可导出');
          return;
        }
        
        // 构建CSV内容
        let csvContent = "ID,姓名,所在科室,手机号码,身份证号,奖品,时间\n";
        
        appData.winners.forEach(winner => {
          csvContent += `${winner.id},`;
          csvContent += `${winner.name},`;
          csvContent += `${winner.department},`;
          csvContent += `${winner.phone},`;
          csvContent += `${winner.idCard},`;
          csvContent += `${winner.prizeName},`;
          csvContent += `${utils.formatDate(winner.time)}\n`;
        });
        
        // 创建下载链接
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `工行徽章抽奖数据_${new Date().toLocaleDateString()}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        utils.showToast('数据导出成功');
      }
    };

    // 事件监听
    function setupEventListeners() {
      // 登录表单提交
      elements.loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = elements.usernameInput.value.trim();
        const password = elements.passwordInput.value.trim();
        
        if (username === 'admin' && password === 'admin') {
          utils.showPage('admin');
          utils.showToast('登录成功');
        } else {
          utils.showToast('用户名或密码错误');
        }
      });
      
      // 普通用户进入 - 先显示扫码页面
      elements.userEnterLink.addEventListener('click', (e) => {
        e.preventDefault();
        utils.showPage('wechat-scan');
      });
      
      // 已扫码，进入抽奖
      elements.scanCompleteBtn.addEventListener('click', () => {
        appData.currentUser.wechatScanned = true;
        utils.showPage('user');
        utils.showToast('扫码成功，欢迎参与抽奖');
      });
      
      // 管理员退出登录
      elements.logoutBtn.addEventListener('click', () => {
        utils.showPage('login');
        utils.showToast('已退出登录');
      });
      
      // 开始抽奖
      elements.drawBtn.addEventListener('click', () => {
        drawLogic.startDraw();
      });
      
      // 再试一次
      elements.retryBtn.addEventListener('click', () => {
        utils.showDrawState('ready');
      });
      
      // 返回首页
      elements.backBtn.addEventListener('click', () => {
        utils.showDrawState('ready');
      });
      
      // 提交中奖信息
      elements.infoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = {
          name: document.getElementById('name').value.trim(),
          department: document.getElementById('department').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          idCard: document.getElementById('id-card').value.trim()
        };
        
        // 简单验证
        if (!formData.name) return utils.showToast('请输入姓名');
        if (!formData.department) return utils.showToast('请输入所在科室');
        if (!formData.phone || formData.phone.length !== 11) return utils.showToast('请输入正确的手机号码');
        if (!formData.idCard || (formData.idCard.length !== 15 && formData.idCard.length !== 18)) return utils.showToast('请输入正确的身份证号');
        
        // 提交信息
        drawLogic.submitWinnerInfo(formData);
      });
      
      // 导出数据
      elements.exportBtn.addEventListener('click', () => {
        adminFunctions.exportData();
      });
    }

    // 初始化
    function init() {
      // 设置初始数据显示
      elements.participantCount.textContent = appData.totalParticipants;
      
      // 设置页面状态
      utils.showPage('login');
      
      // 设置事件监听
      setupEventListeners();
      
      // 为adminFunctions添加别名，方便在页面切换时调用
      utils.updateAdminDashboard = adminFunctions.updateDashboard.bind(adminFunctions);
    }

    // 启动应用
    init();
  </script>
</body>
</html>
